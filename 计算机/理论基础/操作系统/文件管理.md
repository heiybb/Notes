六、文件管理
  1、相关概念
		数据项
			最低级的数据组织形式，可以分为以下两种类型
				基本数据项
					描述对象某种属性的字符集，数据组织中可以命名的最小逻辑数据单位，即原子数据，又称为数据元素或字段，命名往往与属性一致，而除了数据名外，基本数据项还应包含数据类型——由描述的对象属性决定
				组合数据项
					基本数据项的组合，为区别于记录，一般表示为一个复杂属性，而不是一个对象的“所有”属性
		记录
			一组相关数据项的集合，用来描述一个对象在某些方面的属性，通常选出记录中的一个数据项作为关键字进行索引（其实就是类似于数据库）
		文件
			由创建者定义、具有文件名的一组相关元素的集合，文件必须含有文件名，同时每个文件会含有一些属性（具体依据系统决定），一般有文件类型、文件长度、文件的物理位置、文件的创建时间等属性，根据文件的定义，可以把文件分为以下两种
				有结构文件：由一系列记录组成
				无结构文件：仅仅是一串字符流，即没有特定的组织，这样在无结构文件中文件就是最小组织单位
	
	2、文件类型（通过不同方法进行文件分类，不同种类文件不同方法管理）
		按用途分类
			系统文件：系统程序、操作系统的构成文件，默认受保护，不由用户更改
			用户文件：由用户控管的文件
			库文件：用来链接、主要面向程序员的文件
		按数据形式分类
			源文件：由源程序和数据构成的相关文件，一般为ASCII码
			目标文件：编译但未链接的二进制文件，以.obj表示（理论上）
			可执行文件：链接并可执行的二进制文件
		按存储控制属性分类（显然3种权限8种配对方法，但理论只有3种有意义）
			只执行文件：允许调用执行，不允许读写
			只读文件：只允许读
			读写文件：可读可写
		按组织形式和处理方式分类
			普通文件：除目录文件和特殊文件外的文件
			目录文件：用来管理文件系统数据结构的相关文件
			特殊文件：I/O设备文件
		
	3、文件系统模型
		文件系统实际上是
			对象及属性->对对象管理和操作的服务集合（系统调用）->文件系统接口->程序与用户
			
		管理对象
			文件系统管理的对象包括文件（直接管理对象）、目录（辅助管理文件）与磁盘（磁带）空间（与物理空间的对应）
		对对象管理和操作的服务集合
			文件系统的核心部分，包括对文件存储空间的管理、对文件目录的管理、逻辑地址与物理地址的转换机制、文件的读写管理、文件的共享与保护等
		文件系统的接口
			命令接口：与用户的接口
			程序接口：供程序使用的接口（系统调用）
		
	4、文件操作
		最基本的文件操作
			创建文件：
				分配系统空间，在对应的目录文件中建立目录项
			删除文件：
				删除目录文件中对应目录项，回收文件所占空间
			读文件：
				给出文件名和读入的内存地址——系统调用，然后查找目录得到外存地址，接着通过目录项中的读指针进行读操作
			写文件：
				给出文件名和读入的内存地址——系统调用，然后查找目录得到外存地址，接着通过目录项中的写指针进行写操作
			截断文件：
				需要更新文件时，且文件属性未变，这时就不需要删除文件后重新建立，而采用截断文件将文件长度置为0——放弃原文件内容，然后重新写入
			设置文件读/写位置：
				前面的读/写操作只提供顺序读写，这里就是设置文件读/写指针，可以随机读/写
				
		文件“打开”与“关闭”操作
			大多数OS进行文件操作时有以下两步
				先通过检索目录文件来找到指定文件属性与其在外存上的存储位置
				然后检查属性与权限后对文件进行相应操作
			但如果需要进行多次读/写时，每次查找文件目录就过于慢了，所以在内存中建立一个文件表，用于映射打开的文件与外存地址，即每次申请操作文件就先打开文件，系统将文件名加载到文件表中，同时保存对应地址，再返回一个索引号给操作人员，操作人员通过这个唯一索引操作文件（与进程号有异曲同工之妙），不需要再操作时就“关闭”，即清掉文件表中对应项
		
		文件其它操作
			理论与实际相差甚远，所以理论上完全可以用最基本操作完成任何操作的文件系统在实际并不管用，因此大部分OS都加入特殊操作以方便用户和程序员，一般把这些操作分为以下几种
				文件属性相关操作：
					文件名、权限、拥有者等相关属性的修改
				目录相关操作：
					创建、修改、删除目录等操作
				组合操作：
					将一些基本操作合并形成复杂操作，但面向用户和程序员时依旧简单，如文件拷贝=新建文件+文件读/写操作
			
	5、文件逻辑结构分类
		有结构文件
			顺序文件
				有一系列记录顺序排列组成，其记录一般为“定长记录”
			索引文件
				记录为“变长记录”时一般建立索引表，为每条记录都建立索引，索引表单独存放？
			索引顺序文件
				顺序文件和索引文件的结合，只记录一组记录中的第一条记录，通过先选择所在组数，再通过顺序查找找到记录（比如字典，以首字母作为索引建立26个索引表项，然后通过字符串比较算法得到单词所在组数，接着在这个组中顺序查找找到单词）
		无结构文件
		
	6、文件逻辑结构细化
		顺序文件
			逻辑记录排序
				串结构：按记录写入的时间顺序排列
				顺序结构：按关键字进行顺序排列，在检索时这种结构更高效
			顺序文件的读/写操作
				读/写操作最重要的就是读/写指针，当记录为定长时，每读完一条记录后加上定长长度，为变长时，每条记录完后有一个固定字长数据用来存储刚读完的这个记录的长度，这不符合常识，它读多少才知道后面的这个数据记录的是长度
			顺序文件的优缺点
				优点
					在进行批量信息存取时，效率最高，且是唯一能在磁带上运行的文件结构
				缺点
					查找记录需要的开销太大
					删除记录和增加记录的开销大（这个原理等同于线性表数据结构），可以通过增加一个运行记录文件（或称事务文件）——先记录需要增加、删除等修改信息，等计算机空闲或固定时间在合并事务文件与顺序文件
		索引文件
			为每一个记录建立一个索引，可随机查找、存取，优点就是快，缺点就是存储花销太大
		索引顺序文件
			以刚刚那个单词查找为例子，优点缺点都很均衡
		直接文件->哈希文件
			前面几种逻辑结构文件，都是通过关键字索引找到对应项的物理地址，而直接文件就是对给定的关键字直接找到文件，这种直接关系最好的代表就是哈希文件，显然，哈希文件就是哈希函数的文件系统应用，一般将文件系统的哈希函数直接存于系统调用中
		
	7、外存分配方式
			磁盘的物理分配方式，在采用不同的分配方式就行成不同的文件物理结构（不同于文件的逻辑结构），且一个文件系统中只能采用一种外存分配方式，一般外存的分配方式和对应的文件物理结构有如下三种
				连续分配：顺序式文件结构（不同于顺序文件的逻辑结构）
				链接分配：链接式文件结构
				索引分配：索引式文件结构（不同于索引式文件的逻辑结构）
				
	8、外存分配细化
			连续分配
				连续分配采用顺序存储方式，即一个文件在外存中会连续占用盘块，一般连续盘块会在同一磁道上面连续存储，则连续分配的优点如下
					访问容易：
						只要知道文件开始的第一个盘块，就可以顺序快速存取
					访问时间快：
						一般在同一个文件在同一磁道，则访问时不需要移动磁头，只有当当前磁道访问完成后，才进行下一个磁道访问
				缺点
					要求连续的存储空间：
						必须要连续的空闲存储空间大于文件大小才能存储，所以当很多小文件占用空间，然后再删除后就会存在很多小碎片，这就是所谓的“磁盘碎片”
					必须事先知道文件长度：
						在装入前，必须先知道长度，如找到一空闲区，当装入到已占用区，文件却还没有装完，就会出错，则必须先知道文件大小，有时可直接知道文件大小，但有时必须预估，而且文件一般会动态增长，当当前空闲区装不下的时候，又要重新估计、换位置，则决定放到哪一块空闲区间是个很麻烦的事情，效率低下
			
			隐式链接分配
				目录中的每个目录项均存储文件的头盘块指针和尾盘块指针，然后每个盘块都需分出若干位用来存储指向下一个盘块的指针，文件尾盘块指向的下一个盘块为空
			显示链接分配
				显示的存储每一个盘块指向的下一盘块指针，即把这些指针形成一个表，即FAT（文件分配表），FCB中则存储起始盘块号
			
				
				
			
	9、FAT、NTFS
		FAT是基于显示链接分配发展的一种文件系统，主要应用于早期的MS-DOS上，MS-DOS中引入了“卷”的概念，即将磁盘分为多个逻辑磁盘，MS-DOS最多支持4个逻辑磁盘（也称为分区）
		
		FAT12
			每个分区分配两张FAT表，若以扇区作为最基本的物理存储分配单位，每个FAT表项为12位，则文件系统每个分区最多可以支持2^12*512=2M的容量，则整个文件系统最多可支持8M的容量
			
			但显然FAT表不仅支持8M的容量，其解决方案就是引入一个新的分配单位——簇，一个簇一般设置为含有2*n个盘区，而FAT12可以设置为含有一个扇区、两个扇区、四个扇区、八个扇区，即最大支持容量64M，当引入簇这个单位后，簇就作为最基本的分配单位，此时随之而来的就是“零头”的增多，簇越大“零头”就越明显
		
			FAT12只支持8+3格式的文件名
		
		FAT16
			在FAT12的基础上，将FAT表项改为16位，FAT16中簇支持的盘块数为4、8、16、32、64，则支持的最大分区空间为2GB
			
			FAT16仍然只支持8+3格式的文件名，而Win95后的FAT16扩展了这一功能，支持的文件名为255个字符，称为VFAT
			
		FAT32
			在FAT16的基础上，又增加了FAT表项的位宽为32，FAT32中每个簇固定为4KB，但此时FAT32支持的最大分区为2TB!=4KB*2^32，FAT32比FAT16的存储器利用率提高了约15%
			
			由于文件系统设置的问题，FAT32必须有65537个簇，即不支持小于512M的容量，单文件也不能超过4GB，且由于文件分配表的扩张，运行速度比FAT16都要慢，甚至FAT32不支持向下兼容
			
		NTFS
			NTFS在FAT32上又将FAT表项改为64位，所以理论上支持的物理大小基本上不会超过；将卷上簇的大小称为卷因子，每个卷的卷因子可以不同，当卷（即分区）<=512M时，默认簇大小为512字节，当卷大小为1G时，默认簇大小为2KB，当卷大小为2G时，默认簇大小为4KB，实际默认卷因子为4KB；当然NTFS支持的最大簇可达64KB
			
			NTFS具有了和物理磁盘盘块大小的无关性，且可以根据盘块的大小动态的选择簇大小
			
			NTFS采用LCN（逻辑簇号）和VCN（虚拟簇号）来进行地址映射，LCN即以卷为单位，将簇排序，然后通过LCN*簇因子映射卷内物理地址；而VCN则是以文件为单位，将文件占有的簇排序，当得到文件首簇时，就先映射为LCN，在转换为卷内物理地址
			
			NTFS具有很强的容错性
			
			NTFS支持255个字符的长文件名，支持32767个字符的绝对路径名
			
			NTFS支持文件加密、文件压缩功能
			
	10、索引分配
		链式分配的好处很明显，但同时也引入了其他问题，其中两个重要问题如下
			1)不支持高效的直接存取，即访问文件的第i个簇区的时候，必须从文件开始的簇对FAT表一步步向下链接，直到序号为i截止
			2)需要占用较多的内存空间，即访问一个文件就需要将整个FAT表装载进内存，而FAT表一般很大
			
		此时引入索引分配可解决这个问题，即为每个文件单独做一个索引表，表中顺序存储文件占用的簇的LCN，当要查找文件的第i个簇区时，只需要知道这个索引表的位置，然后求得存储第i个“簇区号占用索引项”位置，读取LCN就可以直接得到物理位置；显然，这回增加磁盘的占用空间，特别是小文件，会大量降低磁盘利用率
